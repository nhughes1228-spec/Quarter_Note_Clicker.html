<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Manuscript Note Clicker</title>
  <style>
    :root{
      --ink:#1e1a16;
      --ink2:#2b241e;
      --muted:#5a4f45;
      --paper:#f3e7cf;
      --paper2:#eadbbd;
      --line:rgba(35,29,24,.18);
      --shadow: 0 16px 40px rgba(0,0,0,.22);
      --radius:16px;
      --accent:#2c6e7a;
      --accent2:#6b3c2a;
      --good:#1d7a41;
      --warn:#8a5a00;
      --bad:#a03c3c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--ink);
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(44,110,122,.14), transparent 55%),
        radial-gradient(900px 700px at 85% 20%, rgba(107,60,42,.10), transparent 60%),
        linear-gradient(180deg, var(--paper), var(--paper2));
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.22;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(35,29,24,.09) 0px,
          rgba(35,29,24,.09) 1px,
          transparent 1px,
          transparent 10px
        );
      mix-blend-mode:multiply;
    }
    header{
      padding:16px 16px 12px;
      position:sticky; top:0; z-index:5;
      background: linear-gradient(to bottom, rgba(243,231,207,.94), rgba(243,231,207,.78));
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    h1{margin:0; font-size:18px; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:12px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .hud{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      background: rgba(255,255,255,.45);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      display:flex; gap:8px; align-items:center;
      box-shadow: 0 8px 22px rgba(0,0,0,.10);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .pill b{font-size:13px}
    main{padding:16px; max-width:1200px; margin:0 auto}
    .grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: rgba(255,255,255,.55);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:12px 14px;
      font-size:14px; letter-spacing:.3px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.40);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      flex-wrap:wrap;
    }
    .content{padding:12px 14px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:8px 0; border-bottom:1px dashed rgba(35,29,24,.18)}
    .row:last-child{border-bottom:none}
    .muted{color:var(--muted)}
    button{
      background: rgba(255,255,255,.60);
      color:var(--ink2);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      font-weight:800;
      letter-spacing:.2px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      user-select:none;
    }
    button:hover{background: rgba(255,255,255,.80); border-color: rgba(44,110,122,.35)}
    button:active{transform: translateY(1px)}
    button:disabled{opacity:.45; cursor:not-allowed}
    .primary{
      background: linear-gradient(135deg, rgba(44,110,122,.18), rgba(255,255,255,.65));
      border-color: rgba(44,110,122,.32);
    }
    .danger{border-color: rgba(160,60,60,.30)}
    .table{display:flex; flex-direction:column; gap:8px}
    .mini{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 10px;
      background: rgba(255,255,255,.42);
      border: 1px solid rgba(35,29,24,.16);
      border-radius: 14px;
    }
    .mini .name{display:flex; flex-direction:column; gap:2px}
    .top{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .tag{
      font-size:11px; padding:2px 8px; border-radius:999px;
      border:1px solid rgba(35,29,24,.18);
      color:var(--muted);
      background: rgba(255,255,255,.55);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .tag.good{color:var(--good); border-color: rgba(29,122,65,.22); background: rgba(29,122,65,.06)}
    .tag.warn{color:var(--warn); border-color: rgba(138,90,0,.22); background: rgba(138,90,0,.06)}
    .tag.bad{color:var(--bad); border-color: rgba(160,60,60,.22); background: rgba(160,60,60,.06)}
    .right{display:flex; flex-direction:column; gap:6px; align-items:flex-end; justify-content:center}
    .cost{font-size:12px; color:var(--muted); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .mono{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .clickZone{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; padding:16px 0 6px;
    }
    .noteBtn{
      width:220px; height:220px;
      border-radius: 999px;
      display:grid; place-items:center;
      font-size:112px;
      user-select:none;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.88), rgba(255,255,255,.42));
      border:1px solid rgba(44,110,122,.26);
      box-shadow: 0 20px 60px rgba(0,0,0,.20);
      color: var(--ink2);
    }
    .noteBtn:hover{border-color: rgba(44,110,122,.55)}
    .noteBtn:active{transform: translateY(2px)}
    .bigNotes{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      font-weight: 900;
      letter-spacing: .4px;
      font-size: 34px;
      color: rgba(43,36,30,.92);
      text-shadow: 0 1px 0 rgba(255,255,255,.55);
    }
    .miniHud{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .toast{
      position:fixed; right:14px; bottom:14px;
      display:flex; flex-direction:column; gap:8px;
      max-width: 420px;
      z-index:10;
    }
    .toast .t{
      background: rgba(255,255,255,.86);
      border:1px solid rgba(35,29,24,.20);
      border-left: 4px solid rgba(44,110,122,.75);
      padding:10px 12px;
      border-radius: 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,.16);
      font-size: 12px;
      color: var(--ink2);
      backdrop-filter: blur(6px);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .footer{
      margin-top:10px; padding:10px 14px;
      color: var(--muted); font-size:12px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.35);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .inkSig{
      font-family: "Brush Script MT", "Snell Roundhand", "Apple Chancery", cursive;
      font-size: 18px;
      color: rgba(43,36,30,.85);
    }
    .smallSans{font-size:12px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .seg{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .seg button{
      padding:7px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight:900;
    }
    .seg button.active{
      background: rgba(44,110,122,.18);
      border-color: rgba(44,110,122,.35);
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Manuscript Note Clicker</h1>
    <div class="sub">Click â™©, hire instruments (score order), Ink is meta, prestige for Patrons.</div>
  </div>
  <div class="hud">
    <div class="pill"><span class="muted">Notes</span> <b class="mono" id="notesHud">0</b></div>
    <div class="pill"><span class="muted">Notes/sec</span> <b class="mono" id="npsHud">0</b></div>
    <div class="pill"><span class="muted">Click</span> <b class="mono" id="npcHud">1</b><span class="muted">/click</span></div>
    <div class="pill"><span class="muted">Ink</span> <b class="mono" id="inkHud">0</b></div>
    <div class="pill"><span class="muted">Patrons</span> <b class="mono" id="patronsHud">0</b></div>
  </div>
</header>

<main>
  <div class="grid">

    <section class="card">
      <h2>
        <span>â™© The Note</span>
        <span class="tag good">Autosave: ON</span>
      </h2>
      <div class="content">
        <div class="clickZone">
          <button class="noteBtn" id="noteBtn" aria-label="Click the quarter note">â™©</button>

          <div class="bigNotes mono" id="bigNotes">0 Notes</div>

          <div class="miniHud">
            <div class="pill"><span class="muted">Notes/sec</span> <b class="mono" id="npsMini">0</b></div>
            <div class="pill"><span class="muted">Ink bonus</span> <b class="mono" id="inkBonusMini">x1.000</b></div>
            <div class="pill"><span class="muted">Patron bonus</span> <b class="mono" id="patronBonusMini">x1.00</b></div>
          </div>

          <div class="muted" style="text-align:center; max-width:560px;">
            <span class="inkSig">In ink, we trust.</span>
            <div class="smallSans" style="margin-top:6px;">
              Buy any instrument â†’ gain <b>+1 Ink</b> permanently. Notes buy instruments & their upgrades.
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <b>Prestige: Court Patrons</b>
            <div class="muted smallSans">Lifetime Notes determine Patron gains. Ink persists.</div>
            <div class="muted smallSans mono" id="prestigeInfo">Lifetime: 0 â€¢ Gain: +0 Patron(s)</div>
          </div>
          <button class="primary" id="prestigeBtn">ðŸŽ© Prestige</button>
        </div>

        <div class="row">
          <div>
            <b>Controls</b>
            <div class="muted smallSans">Manual save, hard reset.</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
            <button id="saveBtn">ðŸ’¾ Save</button>
            <button class="danger" id="resetBtn">ðŸ§¨ Hard Reset</button>
          </div>
        </div>

        <div class="footer">
          <span class="mono" id="clock">â€”</span>
          <span class="muted">Bulk buy + section synergy upgrades enabled.</span>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>
        <span>Orchestra & Upgrades</span>
        <span class="seg" aria-label="Bulk buy mode">
          <span class="muted smallSans">Buy:</span>
          <button id="buy1"  class="active" data-buymode="1">x1</button>
          <button id="buy10" data-buymode="10">x10</button>
          <button id="buy100" data-buymode="100">x100</button>
          <button id="buyMax" data-buymode="max">Max</button>
        </span>
      </h2>
      <div class="content">
        <div class="muted smallSans" style="margin-bottom:8px;">Instruments (buildings)</div>
        <div class="table" id="buildingList"></div>

        <div style="height:10px"></div>

        <div class="muted smallSans" style="margin-bottom:8px;">Instrument Upgrades (Notes)</div>
        <div class="table" id="noteUpgradeList"></div>

        <div style="height:10px"></div>

        <div class="muted smallSans" style="margin-bottom:8px;">Section Synergies (Notes)</div>
        <div class="table" id="synergyUpgradeList"></div>

        <div style="height:10px"></div>

        <div class="muted smallSans" style="margin-bottom:8px;">Archive Upgrades (Ink â€” permanent)</div>
        <div class="table" id="inkUpgradeList"></div>

        <div class="footer">
          <span class="muted">Synergies boost whole families. Ladders boost individual instruments.</span>
          <span class="muted">Ink upgrades grow slowly, then compound.</span>
        </div>
      </div>
    </section>

  </div>
</main>

<div class="toast" id="toast"></div>

<script>
(() => {
  // ---------- Utilities ----------
  const $ = (sel)=>document.querySelector(sel);
  const now = ()=>Date.now();

  const fmt = (n) => {
    if (!isFinite(n)) return "âˆž";
    const abs = Math.abs(n);
    if (abs < 1000) return Math.floor(n).toString();
    const units = ["K","M","B","T","Qa","Qi","Sx","Sp","Oc","No"];
    let u = -1, x = abs;
    while (x >= 1000 && u < units.length-1) { x/=1000; u++; }
    const val = (n/Math.pow(1000,u+1));
    return (val >= 100 ? val.toFixed(0) : val >= 10 ? val.toFixed(1) : val.toFixed(2)) + units[u];
  };
  const fmtExact = (n) => {
    if (!isFinite(n)) return "âˆž";
    return n.toLocaleString(undefined,{maximumFractionDigits:2});
  };

  function toast(msg){
    const t = document.createElement("div");
    t.className = "t";
    t.textContent = msg;
    $("#toast").appendChild(t);
    setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(4px)"; t.style.transition="all .35s ease"; }, 2600);
    setTimeout(()=>t.remove(), 3200);
  }

  // ---------- Buildings (score-ish order) ----------
  const BUILDINGS = [
    { id:"piccolo",     name:"Piccolo",       family:"Winds",   baseCost: 15,     costMult: 1.15, nps: 0.1 },
    { id:"flute",       name:"Flute",         family:"Winds",   baseCost: 100,    costMult: 1.15, nps: 1   },
    { id:"oboe",        name:"Oboe",          family:"Winds",   baseCost: 1100,   costMult: 1.15, nps: 8   },
    { id:"enghorn",     name:"English Horn",  family:"Winds",   baseCost: 12000,  costMult: 1.15, nps: 47  },
    { id:"bassoon",     name:"Bassoon",       family:"Winds",   baseCost: 130000, costMult: 1.15, nps: 260 },
    { id:"clarinet",    name:"Clarinet",      family:"Winds",   baseCost: 1.4e6,  costMult: 1.15, nps: 1400},
    { id:"basscl",      name:"Bass Clarinet", family:"Winds",   baseCost: 2.0e7,  costMult: 1.15, nps: 7800},

    { id:"horn",        name:"Horn",          family:"Brass",   baseCost: 3.3e8,  costMult: 1.15, nps: 44000},
    { id:"trumpet",     name:"Trumpet",       family:"Brass",   baseCost: 5.1e9,  costMult: 1.15, nps: 260000},
    { id:"trombone",    name:"Trombone",      family:"Brass",   baseCost: 7.5e10, costMult: 1.15, nps: 1600000},
    { id:"tuba",        name:"Tuba",          family:"Brass",   baseCost: 1.0e12, costMult: 1.15, nps: 1.0e7},

    { id:"timpani",     name:"Timpani",       family:"Perc",    baseCost: 1.4e13, costMult: 1.15, nps: 6.5e7},
    { id:"perc",        name:"Percussion",    family:"Perc",    baseCost: 2.2e14, costMult: 1.15, nps: 4.0e8},

    { id:"harp",        name:"Harp",          family:"Other",   baseCost: 3.7e15, costMult: 1.15, nps: 2.5e9},
    { id:"piano",       name:"Piano/Celesta", family:"Other",   baseCost: 6.0e16, costMult: 1.15, nps: 1.6e10},

    { id:"vln1",        name:"Violin I",      family:"Strings", baseCost: 1.0e18, costMult: 1.15, nps: 1.0e11},
    { id:"vln2",        name:"Violin II",     family:"Strings", baseCost: 1.7e19, costMult: 1.15, nps: 7.0e11},
    { id:"viola",       name:"Viola",         family:"Strings", baseCost: 2.8e20, costMult: 1.15, nps: 5.0e12},
    { id:"cello",       name:"Cello",         family:"Strings", baseCost: 4.6e21, costMult: 1.15, nps: 3.6e13},
    { id:"bass",        name:"Bass",          family:"Strings", baseCost: 7.5e22, costMult: 1.15, nps: 2.6e14},
  ];

  // ---------- NOTE Upgrades (per-building ladder) ----------
  const UPGRADE_MILESTONES = [1, 5, 10, 25, 50, 100, 200, 400];
  const UPGRADE_COST_MULTS = [7, 33, 160, 900, 5200, 30000, 180000, 1100000];
  const UPGRADE_NAME_TEMPLATES = [
    "Etude Book",
    "Better Pads",
    "Handcrafted Mouthpiece",
    "Sectional Rehearsals",
    "Masterclass Series",
    "Principal Auditions",
    "Touring Season",
    "Legendary Legacy"
  ];

  const noteUpgradeId = (buildingId, tierIdx) => `nu_${buildingId}_${tierIdx}`;

  function buildNoteUpgrades(){
    const upgrades = [];
    for (const b of BUILDINGS){
      for (let i=0;i<UPGRADE_MILESTONES.length;i++){
        const milestone = UPGRADE_MILESTONES[i];
        const mult = UPGRADE_COST_MULTS[i];
        upgrades.push({
          id: noteUpgradeId(b.id, i),
          buildingId: b.id,
          name: `${b.name}: ${UPGRADE_NAME_TEMPLATES[i]}`,
          desc: `${b.name} output x2 (requires ${milestone} owned)`,
          costNotes: Math.floor(b.baseCost * mult),
          requireOwned: milestone,
          apply: (s)=>{ s.buildingMult[b.id] *= 2; }
        });
      }
    }
    return upgrades;
  }
  const NOTE_UPGRADES = buildNoteUpgrades();

  // ---------- Section Synergy Upgrades (Notes) ----------
  function buildSynergyUpgrades(){
    const idsByFamily = (fam) => BUILDINGS.filter(b=>b.family===fam).map(b=>b.id);

    const WINDS = idsByFamily("Winds");
    const BRASS = idsByFamily("Brass");
    const STRINGS = idsByFamily("Strings");
    const PERC = idsByFamily("Perc");

    const groupCount = (s, ids) => ids.reduce((a,id)=>a+(s.owned[id]||0), 0);
    const groupBaseCostSum = (ids) => ids.reduce((a,id)=>a+(BUILDINGS.find(b=>b.id===id)?.baseCost||0), 0);

    // Costs scale off family â€œweightâ€ so late families cost more.
    const windsBase = groupBaseCostSum(WINDS);
    const brassBase = groupBaseCostSum(BRASS);
    const stringsBase = groupBaseCostSum(STRINGS);
    const percBase = groupBaseCostSum(PERC);

    const upgrades = [
      // broad family boosts
      {
        id:"syn_winds_1",
        name:"Wind Consort",
        desc:"All Winds output +10%",
        costNotes: Math.floor(windsBase * 2.5),
        can: s => groupCount(s, WINDS) >= 25,
        apply: s => WINDS.forEach(id => s.buildingMult[id] *= 1.10)
      },
      {
        id:"syn_winds_2",
        name:"Woodwind Orchestra",
        desc:"All Winds output +25%",
        costNotes: Math.floor(windsBase * 10),
        can: s => groupCount(s, WINDS) >= 100,
        apply: s => WINDS.forEach(id => s.buildingMult[id] *= 1.25)
      },
      {
        id:"syn_brass_1",
        name:"Brass Choir",
        desc:"All Brass output +10%",
        costNotes: Math.floor(brassBase * 2.5),
        can: s => groupCount(s, BRASS) >= 25,
        apply: s => BRASS.forEach(id => s.buildingMult[id] *= 1.10)
      },
      {
        id:"syn_brass_2",
        name:"Symphonic Brass",
        desc:"All Brass output +25%",
        costNotes: Math.floor(brassBase * 10),
        can: s => groupCount(s, BRASS) >= 100,
        apply: s => BRASS.forEach(id => s.buildingMult[id] *= 1.25)
      },
      {
        id:"syn_strings_1",
        name:"String Section",
        desc:"All Strings output +10%",
        costNotes: Math.floor(stringsBase * 2.5),
        can: s => groupCount(s, STRINGS) >= 25,
        apply: s => STRINGS.forEach(id => s.buildingMult[id] *= 1.10)
      },
      {
        id:"syn_strings_2",
        name:"Philharmonic Strings",
        desc:"All Strings output +25%",
        costNotes: Math.floor(stringsBase * 10),
        can: s => groupCount(s, STRINGS) >= 100,
        apply: s => STRINGS.forEach(id => s.buildingMult[id] *= 1.25)
      },
      {
        id:"syn_perc_1",
        name:"Percussion Battery",
        desc:"All Percussion output +20%",
        costNotes: Math.floor(percBase * 3.5),
        can: s => groupCount(s, PERC) >= 10,
        apply: s => PERC.forEach(id => s.buildingMult[id] *= 1.20)
      },
      {
        id:"syn_perc_2",
        name:"Rhythmic Engine",
        desc:"All Percussion output +40%",
        costNotes: Math.floor(percBase * 14),
        can: s => groupCount(s, PERC) >= 50,
        apply: s => PERC.forEach(id => s.buildingMult[id] *= 1.40)
      },

      // specialty â€œfunâ€ synergies
      {
        id:"syn_doublereeds",
        name:"Double Reeds Studio",
        desc:"Oboe + English Horn + Bassoon output x2",
        costNotes: Math.floor((BUILDINGS.find(b=>b.id==="oboe").baseCost
                             + BUILDINGS.find(b=>b.id==="enghorn").baseCost
                             + BUILDINGS.find(b=>b.id==="bassoon").baseCost) * 120),
        can: s => ((s.owned.oboe||0) >= 10 && (s.owned.enghorn||0) >= 5 && (s.owned.bassoon||0) >= 10),
        apply: s => ["oboe","enghorn","bassoon"].forEach(id => s.buildingMult[id] *= 2)
      },
      {
        id:"syn_lowbrass",
        name:"Low Brass Foundation",
        desc:"Trombone + Tuba output +60%",
        costNotes: Math.floor((BUILDINGS.find(b=>b.id==="trombone").baseCost
                             + BUILDINGS.find(b=>b.id==="tuba").baseCost) * 35),
        can: s => ((s.owned.trombone||0) >= 10 && (s.owned.tuba||0) >= 10),
        apply: s => ["trombone","tuba"].forEach(id => s.buildingMult[id] *= 1.60)
      },
    ];

    // Attach helper for UI â€œlocked reasonâ€ text
    upgrades.forEach(u => u._can = u.can);
    upgrades.forEach(u => u.can = (s)=>u._can(s));
    return upgrades;
  }
  const SYNERGY_UPGRADES = buildSynergyUpgrades();

  // ---------- Ink (meta) Upgrades ----------
  function buildInkUpgrades(){
    const ups = [];

    const npsSteps = [
      {cost:10,  mult:1.001, name:"Margin Notes", desc:"+0.1% Notes/sec permanently"},
      {cost:25,  mult:1.002, name:"Clean Copy",   desc:"+0.2% Notes/sec permanently"},
      {cost:60,  mult:1.005, name:"Illuminated Initials", desc:"+0.5% Notes/sec permanently"},
      {cost:140, mult:1.01,  name:"Scribe Guild", desc:"+1% Notes/sec permanently"},
      {cost:320, mult:1.02,  name:"Royal Archive", desc:"+2% Notes/sec permanently"},
      {cost:800, mult:1.05,  name:"Endowment", desc:"+5% Notes/sec permanently"},
    ];
    npsSteps.forEach((s, idx)=>{
      ups.push({
        id:`iu_nps_${idx}`,
        name:s.name,
        desc:s.desc,
        costInk:s.cost,
        can: st => true,
        apply: st => { st.metaNpsMult *= s.mult; }
      });
    });

    const clickFromNpsSteps = [
      {cost:25,  rate:0.001, name:"Quick Quill",  desc:"Each click gains +0.1% of your current Notes/sec"},
      {cost:90,  rate:0.002, name:"Scribe Reflex",desc:"Each click gains +0.2% of your current Notes/sec"},
      {cost:260, rate:0.005, name:"Ink & Tempo",  desc:"Each click gains +0.5% of your current Notes/sec"},
      {cost:900, rate:0.01,  name:"Virtuoso Penmanship", desc:"Each click gains +1% of your current Notes/sec"},
    ];
    clickFromNpsSteps.forEach((s, idx)=>{
      ups.push({
        id:`iu_clicknps_${idx}`,
        name:s.name,
        desc:s.desc,
        costInk:s.cost,
        can: st => true,
        apply: st => { st.clickFromNpsRate += s.rate; }
      });
    });

    const clickMultSteps = [
      {cost:40,  mult:1.02, name:"Sharper Quill", desc:"+2% click power permanently"},
      {cost:150, mult:1.05, name:"Steel Nib",     desc:"+5% click power permanently"},
      {cost:600, mult:1.12, name:"Gold Nib",      desc:"+12% click power permanently"},
      {cost:2500,mult:1.30, name:"Mythic Pen",    desc:"+30% click power permanently"},
    ];
    clickMultSteps.forEach((s, idx)=>{
      ups.push({
        id:`iu_clickmult_${idx}`,
        name:s.name,
        desc:s.desc,
        costInk:s.cost,
        can: st => true,
        apply: st => { st.metaClickMult *= s.mult; }
      });
    });

    return ups;
  }
  const INK_UPGRADES = buildInkUpgrades();

  // ---------- Prestige ----------
  const patronBonus = (patrons) => (1 + patrons * 0.05);
  function patronsFromLifetime(lifetimeNotes){
    return Math.floor(Math.sqrt(lifetimeNotes / 500000));
  }

  // ---------- State ----------
  const KEY = "manuscript_note_clicker_v3";
  const stateDefault = () => ({
    version: 3,

    // run
    notes: 0,
    lifetimeNotes: 0,

    // permanent
    ink: 0,
    patrons: 0,

    // buildings (reset on prestige)
    owned: Object.fromEntries(BUILDINGS.map(b=>[b.id,0])),
    buildingMult: Object.fromEntries(BUILDINGS.map(b=>[b.id,1])),
    noteUpgrades: {},     // reset on prestige
    synergyUpgrades: {},  // reset on prestige

    // run multipliers (reset on prestige)
    baseNpc: 1,
    runClickMult: 1,
    runNpsMult: 1,

    // meta (permanent)
    inkUpgrades: {},
    metaNpsMult: 1,
    metaClickMult: 1,
    clickFromNpsRate: 0,

    // UI
    buyMode: "1", // "1" | "10" | "100" | "max"

    lastTick: now(),
    lastSave: now(),
  });

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return stateDefault();
      const s = JSON.parse(raw);
      const d = stateDefault();

      for (const k of Object.keys(d)){
        if (s[k] === undefined) s[k] = d[k];
      }

      if (!s.owned) s.owned = {};
      if (!s.buildingMult) s.buildingMult = {};
      for (const b of BUILDINGS){
        if (s.owned[b.id] === undefined) s.owned[b.id] = 0;
        if (s.buildingMult[b.id] === undefined) s.buildingMult[b.id] = 1;
      }

      if (!s.noteUpgrades) s.noteUpgrades = {};
      if (!s.synergyUpgrades) s.synergyUpgrades = {};
      if (!s.inkUpgrades) s.inkUpgrades = {};

      if (s.metaNpsMult === undefined) s.metaNpsMult = 1;
      if (s.metaClickMult === undefined) s.metaClickMult = 1;
      if (s.clickFromNpsRate === undefined) s.clickFromNpsRate = 0;

      if (!s.buyMode) s.buyMode = "1";

      return s;
    }catch(e){
      console.warn("Load failed", e);
      return stateDefault();
    }
  }

  let S = load();

  function save(){
    S.lastSave = now();
    localStorage.setItem(KEY, JSON.stringify(S));
    toast("Saved.");
  }

  // ---------- Economy ----------
  function buildingCostAtOwned(b, owned){
    return Math.floor(b.baseCost * Math.pow(b.costMult, owned));
  }

  function buildingCost(b){
    return buildingCostAtOwned(b, S.owned[b.id] || 0);
  }

  function totalNps(){
    let sum = 0;
    for (const b of BUILDINGS){
      const owned = S.owned[b.id] || 0;
      if (owned <= 0) continue;
      const mult = (S.buildingMult[b.id] || 1);
      sum += owned * b.nps * mult;
    }
    return sum * S.runNpsMult * S.metaNpsMult * patronBonus(S.patrons);
  }

  function notesPerClick(){
    const nps = totalNps();
    const fromNps = S.clickFromNpsRate > 0 ? (S.clickFromNpsRate * nps) : 0;
    return ((S.baseNpc * S.runClickMult) + fromNps) * S.metaClickMult * patronBonus(S.patrons);
  }

  function sumCostForK(b, k){
    // cost = base*r^owned + base*r^(owned+1) + ... k terms
    const owned = S.owned[b.id] || 0;
    const r = b.costMult;
    const base = b.baseCost * Math.pow(r, owned);
    if (k <= 0) return 0;
    if (Math.abs(r - 1) < 1e-9) return Math.floor(base * k);
    const total = base * (Math.pow(r, k) - 1) / (r - 1);
    return Math.floor(total);
  }

  function maxAffordableCount(b){
    const owned = S.owned[b.id] || 0;
    const r = b.costMult;
    const budget = S.notes;

    // Quick bail
    const first = buildingCostAtOwned(b, owned);
    if (budget < first) return 0;

    // Estimate using logs, then adjust safely.
    const base = b.baseCost * Math.pow(r, owned);
    let kEst;
    if (Math.abs(r - 1) < 1e-9){
      kEst = Math.floor(budget / base);
    } else {
      // budget >= base * (r^k - 1)/(r-1)
      // r^k <= 1 + budget*(r-1)/base
      const rhs = 1 + (budget * (r - 1) / base);
      kEst = Math.floor(Math.log(rhs) / Math.log(r));
    }
    kEst = Math.max(0, Math.min(1000000, kEst)); // sanity

    // Adjust down if needed
    while (kEst > 0 && sumCostForK(b, kEst) > budget) kEst--;

    // Adjust up if possible (rare but safe)
    while (sumCostForK(b, kEst + 1) <= budget) kEst++;

    return kEst;
  }

  function buyBuilding(id, mode){
    const b = BUILDINGS.find(x=>x.id===id);
    if (!b) return false;

    let k = 1;
    if (mode === "10") k = 10;
    else if (mode === "100") k = 100;
    else if (mode === "max") k = maxAffordableCount(b);

    if (k <= 0) return false;

    const cost = sumCostForK(b, k);
    if (S.notes < cost) return false;

    S.notes -= cost;
    S.owned[id] = (S.owned[id]||0) + k;

    // +1 Ink per building purchased (permanent)
    S.ink += k;

    toast(`Added ${k} Ã— ${b.name} (+${k} Ink).`);
    return true;
  }

  function buyNoteUpgrade(id){
    const u = NOTE_UPGRADES.find(x=>x.id===id);
    if (!u) return;
    if (S.noteUpgrades[id]) return;
    if ((S.owned[u.buildingId]||0) < u.requireOwned) return;
    if (S.notes < u.costNotes) return;

    S.notes -= u.costNotes;
    S.noteUpgrades[id] = true;
    u.apply(S);
    toast(`Upgrade: ${u.name}`);
  }

  function buySynergyUpgrade(id){
    const u = SYNERGY_UPGRADES.find(x=>x.id===id);
    if (!u) return;
    if (S.synergyUpgrades[id]) return;
    if (!u.can(S)) return;
    if (S.notes < u.costNotes) return;

    S.notes -= u.costNotes;
    S.synergyUpgrades[id] = true;
    u.apply(S);
    toast(`Synergy: ${u.name}`);
  }

  function buyInkUpgrade(id){
    const u = INK_UPGRADES.find(x=>x.id===id);
    if (!u) return;
    if (S.inkUpgrades[id]) return;
    if (S.ink < u.costInk) return;
    if (!u.can(S)) return;

    S.ink -= u.costInk;
    S.inkUpgrades[id] = true;
    u.apply(S);
    toast(`Archive: ${u.name}`);
  }

  function clickNote(){
    const gain = notesPerClick();
    S.notes += gain;
    S.lifetimeNotes += gain;
  }

  // ---------- Prestige ----------
  function prestigePreview(){
    const totalWouldHave = patronsFromLifetime(S.lifetimeNotes);
    const gain = Math.max(0, totalWouldHave - S.patrons);
    return { totalWouldHave, gain };
  }

  function doPrestige(){
    const { gain } = prestigePreview();
    if (gain <= 0){
      toast("No new Patrons yet. Keep composing.");
      return;
    }
    const ok = confirm(
      `Prestige will reset your run (Notes, instruments, NOTE-upgrades, Synergies).\n` +
      `You keep Ink + Archive upgrades.\n\n` +
      `You will gain +${gain} Patron(s).\n\nProceed?`
    );
    if (!ok) return;

    S.patrons += gain;

    // reset run
    S.notes = 0;
    S.owned = Object.fromEntries(BUILDINGS.map(b=>[b.id,0]));
    S.buildingMult = Object.fromEntries(BUILDINGS.map(b=>[b.id,1]));
    S.noteUpgrades = {};
    S.synergyUpgrades = {};

    S.baseNpc = 1;
    S.runClickMult = 1;
    S.runNpsMult = 1;

    toast(`You gained ${gain} Patron(s).`);
  }

  // ---------- Offline Progress ----------
  function applyOffline(){
    const t = now();
    const dt = (t - S.lastTick) / 1000;
    if (dt <= 2) return;

    const cap = 6 * 60 * 60;
    const used = Math.min(dt, cap);

    const gained = totalNps() * used;
    S.notes += gained;
    S.lifetimeNotes += gained;

    toast(`Welcome back! +${fmtExact(gained)} Notes from ${Math.floor(used/60)}m offline.`);
  }

  // ---------- UI ----------
  function setBuyMode(mode){
    S.buyMode = mode;
    ["buy1","buy10","buy100","buyMax"].forEach(id=>{
      const btn = $("#"+id);
      const m = btn.getAttribute("data-buymode");
      btn.classList.toggle("active", m === mode);
    });
  }

  function renderHUD(){
    const nps = totalNps();
    const npc = notesPerClick();

    $("#notesHud").textContent = fmt(S.notes);
    $("#npsHud").textContent = fmtExact(nps);
    $("#npcHud").textContent = fmtExact(npc);
    $("#inkHud").textContent = fmt(S.ink);
    $("#patronsHud").textContent = fmt(S.patrons);

    $("#bigNotes").textContent = `${fmt(S.notes)} Notes`;
    $("#npsMini").textContent = fmtExact(nps);

    $("#inkBonusMini").textContent = `x${S.metaNpsMult.toFixed(3)}`;
    $("#patronBonusMini").textContent = `x${patronBonus(S.patrons).toFixed(2)}`;

    const p = prestigePreview();
    $("#prestigeInfo").textContent =
      `Lifetime: ${fmt(S.lifetimeNotes)} â€¢ Gain: +${p.gain} Patron(s) â€¢ Total: ${p.totalWouldHave}`;

    $("#clock").textContent = new Date().toLocaleString();
  }

  function renderBuildings(){
    const el = $("#buildingList");
    el.innerHTML = "";

    for (const b of BUILDINGS){
      const owned = S.owned[b.id] || 0;

      // show cost according to current buy mode
      let k = 1;
      if (S.buyMode === "10") k = 10;
      else if (S.buyMode === "100") k = 100;
      else if (S.buyMode === "max") k = maxAffordableCount(b);

      const cost = sumCostForK(b, k);
      const afford = (k > 0) && (S.notes >= cost);

      const perEach = b.nps * (S.buildingMult[b.id]||1);
      const label = (S.buyMode === "max") ? (k > 0 ? `Add Max (${k})` : "Add Max") : `Add x${k}`;

      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${b.name}</b>
            <span class="tag">${b.family}</span>
            <span class="tag good">Owned: <span class="mono">${owned}</span></span>
          </div>
          <div class="muted smallSans">
            Produces <span class="mono"><b>${fmtExact(perEach)}</b></span> Notes/sec each
            <span class="muted">(before global/meta/patrons)</span>
          </div>
        </div>
        <div class="right">
          <button class="primary" data-buy="${b.id}" ${afford ? "" : "disabled"}>${label}</button>
          <div class="cost mono">Cost: ${k>0 ? fmtExact(cost) : "â€”"} Notes</div>
          <div class="cost">${k>0 ? `+${k} Ink` : "+0 Ink"}</div>
        </div>
      `;
      el.appendChild(div);
    }

    el.querySelectorAll("button[data-buy]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const ok = buyBuilding(btn.getAttribute("data-buy"), S.buyMode);
        if (ok) renderAll();
      });
    });
  }

  function renderNoteUpgrades(){
    const el = $("#noteUpgradeList");
    el.innerHTML = "";

    const relevant = NOTE_UPGRADES.filter(u=>{
      if (S.noteUpgrades[u.id]) return true;
      const owned = S.owned[u.buildingId] || 0;
      return owned >= Math.max(0, u.requireOwned - 4);
    });

    if (relevant.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted smallSans";
      empty.textContent = "Buy an instrument to unlock its first upgrades.";
      el.appendChild(empty);
      return;
    }

    for (const u of relevant){
      const owned = !!S.noteUpgrades[u.id];
      const have = S.owned[u.buildingId] || 0;
      const unlocked = have >= u.requireOwned;
      const afford = S.notes >= u.costNotes;

      const tagClass = owned ? "good" : unlocked ? (afford ? "warn" : "") : "bad";
      const tagText = owned ? "Owned" : unlocked ? "Unlocked" : `Need ${u.requireOwned}`;

      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${u.name}${owned ? " âœ…" : ""}</b>
            <span class="tag ${tagClass}">${tagText}</span>
          </div>
          <div class="muted smallSans">${u.desc}</div>
        </div>
        <div class="right">
          <button data-nu="${u.id}" ${(!owned && unlocked && afford) ? "" : "disabled"}>Buy</button>
          <div class="cost mono">${fmtExact(u.costNotes)} Notes</div>
        </div>
      `;
      el.appendChild(div);
    }

    el.querySelectorAll("button[data-nu]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        buyNoteUpgrade(btn.getAttribute("data-nu"));
        renderAll();
      });
    });
  }

  function renderSynergyUpgrades(){
    const el = $("#synergyUpgradeList");
    el.innerHTML = "";

    for (const u of SYNERGY_UPGRADES){
      const owned = !!S.synergyUpgrades[u.id];
      const can = u.can(S);
      const afford = S.notes >= u.costNotes;

      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${u.name}${owned ? " âœ…" : ""}</b>
            <span class="tag ${owned ? "good" : (can ? (afford ? "warn" : "") : "bad")}">
              ${owned ? "Owned" : (can ? "Available" : "Locked")}
            </span>
          </div>
          <div class="muted smallSans">${u.desc}</div>
        </div>
        <div class="right">
          <button data-syn="${u.id}" ${(!owned && can && afford) ? "" : "disabled"}>Buy</button>
          <div class="cost mono">${fmtExact(u.costNotes)} Notes</div>
        </div>
      `;
      el.appendChild(div);
    }

    el.querySelectorAll("button[data-syn]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        buySynergyUpgrade(btn.getAttribute("data-syn"));
        renderAll();
      });
    });
  }

  function renderInkUpgrades(){
    const el = $("#inkUpgradeList");
    el.innerHTML = "";

    for (const u of INK_UPGRADES){
      const owned = !!S.inkUpgrades[u.id];
      const can = u.can(S);
      const afford = S.ink >= u.costInk;

      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${u.name}${owned ? " âœ…" : ""}</b>
            <span class="tag ${owned ? "good" : (can ? (afford ? "warn" : "") : "bad")}">
              ${owned ? "Owned" : (can ? "Available" : "Locked")}
            </span>
          </div>
          <div class="muted smallSans">${u.desc}</div>
        </div>
        <div class="right">
          <button data-iu="${u.id}" ${(!owned && can && afford) ? "" : "disabled"}>Buy</button>
          <div class="cost mono">${u.costInk} Ink</div>
        </div>
      `;
      el.appendChild(div);
    }

    el.querySelectorAll("button[data-iu]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        buyInkUpgrade(btn.getAttribute("data-iu"));
        renderAll();
      });
    });
  }

  function renderAll(){
    renderHUD();
    renderBuildings();
    renderNoteUpgrades();
    renderSynergyUpgrades();
    renderInkUpgrades();
  }

  // ---------- Tick Loop ----------
  let lastFullRender = 0;
  function tick(){
    const t = now();
    let dt = (t - S.lastTick) / 1000;
    S.lastTick = t;
    dt = Math.min(dt, 0.25);

    const gained = totalNps() * dt;
    if (gained > 0){
      S.notes += gained;
      S.lifetimeNotes += gained;
    }

    if (t - S.lastSave > 30000){
      S.lastSave = t;
      localStorage.setItem(KEY, JSON.stringify(S));
    }

    renderHUD();
    if (t - lastFullRender > 250){
      lastFullRender = t;
      renderBuildings();
      renderNoteUpgrades();
      renderSynergyUpgrades();
      renderInkUpgrades();
    }
  }

  // ---------- Wire Buttons ----------
  $("#noteBtn").addEventListener("click", ()=>{
    clickNote();
    renderHUD();
  });

  $("#prestigeBtn").addEventListener("click", ()=>{
    doPrestige();
    renderAll();
  });

  $("#saveBtn").addEventListener("click", save);

  $("#resetBtn").addEventListener("click", ()=>{
    const ok = confirm("Hard reset will erase your save completely (including Ink & Patrons). Are you sure?");
    if (!ok) return;
    localStorage.removeItem(KEY);
    S = stateDefault();
    toast("Reset complete.");
    renderAll();
  });

  // Bulk buy mode buttons
  document.querySelectorAll("button[data-buymode]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const m = btn.getAttribute("data-buymode");
      setBuyMode(m);
      renderBuildings();
      // persist immediately
      localStorage.setItem(KEY, JSON.stringify(S));
    });
  });

  // ---------- Boot ----------
  applyOffline();
  setBuyMode(S.buyMode);
  renderAll();
  setInterval(tick, 100);

  if (S.lifetimeNotes === 0 && S.notes === 0){
    toast("Click â™© to start!");
  }
})();
</script>
</body>
</html>
